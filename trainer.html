<html>
<head>
	<style>
		#page {
			width: 80%;
			max-width: 800px;
			margin: 0 auto;
		}

		section {
			text-align: center;
		}
		#layout {
			height: 200px;
		}
		textarea {
			width: 100%;
			height: 200px;
		}
		#source {
			height: 300px;
		}
		#input {
			height: 150px;
		}
		#source-view {
			min-height: 30px;
			max-height: 300px;
			overflow: auto;
			text-align: left;
			display: none;
			cursor: pointer;
			margin-bottom: 10px;
		}
		#source-typed {
			background-color: cyan;
		}
		#source-error {
			background-color: orange;
		}
		#source-success {
			background-color: #58e958;
		}
		.success-img {
			display: none;
			width: 100px;
		}
		#page.success .success-img {
			display: inline-block;
		}
		.success-img--flip {
			transform: scaleX(-1);
		}
		section.layout {
			position: relative;
		}
		#word-counter {
			display: none;
			position: absolute;
			right: 10px;
			top: 10px;
			font-size: 14px;
		}
		#page.success #word-counter {
			display: block;
		}
		#firework {
			display: none;
			position: absolute;
			left: 50%;
			top: 0px;
			margin-left: -242px;
			height: 200px;
			width: 485px;
		}
		#page.success #firework {
			display: block;
		}
		#preset-select {
			position: absolute;
			top: 10px;
			left: 0px;
		}
		.return-sign {
			font-size: 12px;
		}
	</style>
	<link rel="icon" type="image/x-icon" href="data:image/png;base64,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"
</head>
<body>
	<div id="page">
		<section>
			<textarea id="source"></textarea>
			<div id="source-view"></div>
		</section>
		<section class="layout">
			<img class="success-img" src="success.png"/>
			<img id="layout" src="layout_eng.png"/>
			<img id="firework" src="firework.gif"/>
			<img class="success-img success-img--flip" src="success.png"/>
			<div id="word-counter"></div>
			<select id="preset-select">
				<option value=''>&lt;pick preset&gt;</option>
				<option value='hard_numbers'>hard numbers</option>
			</select>
		</section>
		<section><textarea id="input"></textarea></section>
	</div>
	
	<script>
		const page = document.getElementById("page");
		const source = document.getElementById("source");
		const sourceView = document.getElementById("source-view");
		const inp = document.getElementById("input");
		const wordCounter = document.getElementById("word-counter");
		const firework = document.getElementById("firework");
		const presetSelect = document.getElementById("preset-select");
		
		const lineBreak = "<span class='return-sign'>↩</span>&nbsp;<br/>";
		
		source.addEventListener("keydown", (e) => {
			if (e.keyCode !== 13) {
				return;
			}
			if (e.shiftKey) {
				source.value = source.value + '\n';
				e.preventDefault();
				return;
			}
			e.stopPropagation();
			e.preventDefault();
			startTask();
		});
		
		function startTask() {
			source.value = source.value
				.trim()
				.replace(/’/g, "'")
				.replace(/[“”]/g, '"')
				.replace(/…/g, '...')
				.replace(/–/g, '-')
				.split('\n').map(x => x.trim()).join('\n');
			inp.value = '';
			source.style.display = 'none';
			sourceView.style.display = 'block';
			
			hightlightCurrentInput();
			page.classList.remove("success");
			inp.disabled = false;
			inp.focus();
		}
		
		sourceView.addEventListener("dblclick", (e) => {
			source.style.display = 'block';
			sourceView.style.display = 'none';
			source.focus();
			source.select();
		});
		
		inp.addEventListener("input", (e) => {
			hightlightCurrentInput();
		});
		inp.addEventListener("keydown", (e) => {
			if (e.keyCode === 32 && e.ctrlKey) {
				console.log(1)
				inp.value = inp.value + source.value.substr(inp.value.length, 1);
				e.preventDefault();
				hightlightCurrentInput();
				return false;
			}
		});
		
		presetSelect.addEventListener("change", (e) => {
			const preset = e.target.value;
			switch (preset) {
				case "hard_numbers":
					generateNumbers();
					break;
			}
			startTask();
		});
		
		function hightlightCurrentInput() {
			let lastMatch = -1;
			while(lastMatch <= inp.value.length && source.value[lastMatch] === inp.value[lastMatch]) {
				lastMatch++;
			}
			const errLength = inp.value.length - lastMatch;
			
			if (errLength === -1 && inp.value.length === source.value.length) {
				successHighlight();
				page.classList.add('success');
				inp.blur();
				inp.disabled = true;
				return;
			}
			
			sourceView.innerHTML = "" + 
			"<span id='source-typed'>" + source.value.substr(0, lastMatch).replace(/\n/g, lineBreak) + "</span>" + 
			"<span id='source-error'>" + source.value.substr(lastMatch, errLength).replace(/\n/g, "<br/>") + "</span>" + 
			"<span id='source-left'>" + source.value.substr(lastMatch + errLength).replace(/\n/g, "<br/>") + "</span>";
		}
		
		function successHighlight(current) {
			current = current || 0;
			sourceView.innerHTML = "" + 
			"<span id='source-success'>" + source.value.substr(0, current).replace(/\n/g, lineBreak) + "</span>" + 
			"<span id='source-typed'>" + source.value.substr(current).replace(/\n/g, "<br/>") + "</span>";
			
			wordCounter.innerHTML = current;
			
			if (current < source.value.length) {
				setTimeout(() => successHighlight(current + 1), 5);
			}
		}
		
		function doDance() {
			const flipClass = "success-img--flip";
			const imgs = document.querySelectorAll(".success-img");
			imgs.forEach(i => {
				if (i.classList.contains(flipClass)) {
					i.classList.remove(flipClass);
				} else {
					i.classList.add(flipClass);
				}
			});
			setTimeout(doDance, 750);
		}
		
		function generateNumbers() {
			const signs = '$%&()[]@#*-+=_';
			source.value = Array(8).fill(0)
				.map(() => Array(8).fill(0)
					.map(() => '' + 
						signs[parseInt(Math.random() * signs.length)] +
						(Math.random() * 100000).toFixed(2) + 
						signs[parseInt(Math.random() * signs.length)]
					)
					.join(' ')
				)
				.join('\n\n')
		}
		
		const presets = {
			'digits': `
				;10a ;10a ;10a ;10a ;10a ;10a ;10a ;10a ;10a ;10a
				a01; a01; a01; a01; a01; a01; a01; a01; a01; a01;

				l29s l29s l29s l29s l29s l29s l29s l29s l29s l29s
				s92l s92l s92l s92l s92l s92l s92l s92l s92l s92l

				k38d k38d k38d k38d k38d k38d k38d k38d k38d k38d
				d83k d83k d83k d83k d83k d83k d83k d83k d83k d83k

				j47f j47f j47f j47f j47f j47f j47f j47f j47f j47f
				f74j f74j f74j f74j f74j f74j f74j f74j f74j f74j

				h56g h56g h56g h56g h56g h56g h56g h56g h56g h56g
				g65h g65h g65h g65h g65h g65h g65h g65h g65h g65h
			`,
		}
		
		window.addEventListener("load", () => source.focus());
		window.addEventListener("load", doDance);
	</script>
</body>
</html>